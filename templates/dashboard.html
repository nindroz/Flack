{% extends "layout.html" %}

{% block title %}
Dashboard
{% endblock %}

{% block body %}
<h1>WELCOME {{name}}
</h1>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
<script type="text/javascript">


    document.addEventListener('DOMContentLoaded',() => {
    
            
        const request= new XMLHttpRequest();
        request.open("GET","/getChannels");
    
        request.onload = () => {
        const data=JSON.parse(request.responseText);
        for ( i=0; i<data.channels.length; i++){
            const ki = document.createElement('li');
            const but = document.createElement("button");
            ki.append(but);
            but.innerHTML=`#${data.channels[i]}`;
            ki.setAttribute("data-name",data.channels[i]);
            document.querySelector("#channels").append(ki);
            
        }
        
        }
        request.send();

        
        

        

        // Connect to websocket
        var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);


        socket.on('connect', () => {

            document.querySelector('#form').onsubmit = () => {
                
                const name = document.querySelector('#channelMake').value;
                socket.emit("make channel",{"name":name});
                return false;
            };
            
            

            document.querySelector('#sendMessage').onsubmit = () => {
                const msg = document.querySelector("#message").value;
                socket.emit("send message", {"message":msg, "channel":"adf"})
                return false;
            }

           


        });
        

        socket.on ('cast channel', data => {
            const ki = document.createElement('li');
            const but = document.createElement("button");
            ki.append(but)
            but.innerHTML=`#${data.channel}`;
            ki.setAttribute("data-name",data.channel);
            console.log(`it work: ${ki.dataset.name}`);
            document.querySelector("#channels").append(ki);
            
            });

        socket.on ("display message", data => {
            console.log(data.message);
            const li = document.createElement("li");
            li.innerHTML=data.message;
            document.querySelector("#testmsg").append(li);
        });

        socket.on ("show channel", data => {
            console.log(data.channel);
        })
    });

    window.addEventListener("load", () =>{
        const channelList = document.getElementById('channels');
        for (let i = 0; i < channelList.children.length; i++) {
            channelList.children[i].children[i].onclick = () => {
                console.log("clicked"); 
                const request1 = new XMLHttpRequest();
                request1.open("POST","/select");

                request1.onload = () => {
                    {}
            } 
                const currentChannel = new FormData();
                currentChannel.append("channel",channelList.children[i].dataset.name);
                request1.send(currentChannel);
                    
        };
        }
        
    });


</script>
<form id="form">
    <input type="text"  id="channelMake">
    <input type="submit" value="make channel">
</form>

<ul id="channels">
</ul>

<hr>

<form id="sendMessage">
    <input type="text" name="message" id="message">
    <input type="submit">
</form>


<!--tempporary-->
<ul id="testmsg">

</ul>


{% endblock %}